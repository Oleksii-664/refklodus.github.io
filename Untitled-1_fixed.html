<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Таблиця рефаунду</title>
<style>
  :root { --bg:#0f1220; --card:#171a2b; --card2:#1f2235; --line:#2a2d3d; --accent:#7c5cff; --accent2:#674bdb; --text:#e8ecf1; }
  *{box-sizing:border-box}
  body {
    font-family: Arial, sans-serif;
    background-color: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 20px;
  }
  h1 {
    text-align: center;
    color: var(--accent);
    margin-bottom: 16px;
  }
  .actions {
    display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-start;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    background-color: var(--card);
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    padding: 10px;
    text-align: center;
    border-bottom: 1px solid var(--line);
    vertical-align: top;
  }
  th {
    background-color: var(--card2);
    position: sticky;
    top: 0;
    z-index: 1;
  }
  input[type="text"], input[type="number"] {
    width: 100%;
    padding: 6px 8px;
    border: none;
    border-radius: 6px;
    background-color: #2a2d3d;
    color: #fff;
  }
  input[type="checkbox"] {
    transform: scale(1.2);
  }
  input[type="file"] {
    width: 100%;
  }
  button {
    padding: 10px 16px;
    background-color: var(--accent);
    color: white;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }
  button:hover { background-color: var(--accent2); }
  .icon-btn {
    padding:6px 10px; border-radius:8px;
  }
  img.preview {
    max-width: 100px;
    max-height: 100px;
    border-radius: 6px;
    display:block;
    margin-top:6px;
    object-fit:cover;
  }
  .image-col {
    min-width: 180px;
  }
  .nowrap { white-space: nowrap; }
  .modal-backdrop {
    position: fixed; inset: 0; background: rgba(0,0,0,.7);
    display:none; align-items:center; justify-content:center;
  }
  .modal-backdrop.open { display:flex; }
  .modal {
    background: var(--card); padding:10px; border-radius:12px;
    max-width: 90vw; max-height: 90vh; overflow:auto;
  }
  .modal img { max-width: 85vw; max-height: 80vh; display:block; }
  .modal .close { display:block; margin-left:auto; margin-bottom:8px; }
</style>
</head>
<body>
  <h1>Таблиця рефаунду</h1>

  <div class="actions">
    <button id="addRowBtn" type="button">Додати рядок</button>
    <button id="clearDataBtn" type="button" title="Очистити всі локальні дані в браузері">Очистити дані</button>
    <span style="opacity:.7;font-size:.9rem;">(дані зберігаються локально в браузері)</span>
  </div>

  <table id="refundTable">
    <thead>
      <tr>
        <th>Назва профілю</th>
        <th>Пошта</th>
        <th>Пароль</th>
        <th>Телефон</th>
        <th>Назва товару</th>
        <th>Ціна товару</th>
        <th>Ціна прогріву</th>
        <th>Ціна продажу</th>
        <th class="nowrap">Рефнутий товар</th>
        <th class="nowrap">Рефнутий прогрів</th>
        <th>Зображення</th>
        <th>Прибуток</th>
        <th>Дія</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal for image preview -->
  <div id="imgModal" class="modal-backdrop" aria-hidden="true">
    <div class="modal">
      <button class="close icon-btn" type="button">✖</button>
      <img src="" alt="Перегляд зображення">
    </div>
  </div>

<script>
(() => {
  const STORAGE_KEY = 'refundData_v2'; // нова схема, щоб уникнути конфлікту зі старими даними
  const tableBody = document.querySelector('#refundTable tbody');
  const addRowBtn = document.getElementById('addRowBtn');
  const clearDataBtn = document.getElementById('clearDataBtn');

  const modal = document.getElementById('imgModal');
  const modalImg = modal.querySelector('img');
  modal.querySelector('.close').addEventListener('click', () => closeModal());
  modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
  function openModal(src){ modalImg.src = src; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); modalImg.src=''; }

  function toNumber(val){ const n = parseFloat(val); return Number.isFinite(n) ? n : 0; }

  function calcProfitForRow(tr){
    const priceProduct = toNumber(tr.querySelector('.priceProduct').value);
    const priceWarmup  = toNumber(tr.querySelector('.priceWarmup').value);
    const priceSell    = toNumber(tr.querySelector('.priceSell').value);
    const productRefunded = tr.querySelector('.productRefunded').checked;
    const warmupRefunded  = tr.querySelector('.warmupRefunded').checked;
    const profit = priceSell - (productRefunded ? 0 : priceProduct) - (warmupRefunded ? 0 : priceWarmup);
    tr.querySelector('.profit').value = profit.toFixed(2);
  }

  function getRowData(tr){
    return {
      profile: tr.querySelector('.profile').value || '',
      email: tr.querySelector('.email').value || '',
      pass: tr.querySelector('.pass').value || '',
      phone: tr.querySelector('.phone').value || '',
      productName: tr.querySelector('.productName').value || '',
      priceProduct: tr.querySelector('.priceProduct').value || '',
      priceWarmup: tr.querySelector('.priceWarmup').value || '',
      priceSell: tr.querySelector('.priceSell').value || '',
      productRefunded: tr.querySelector('.productRefunded').checked,
      warmupRefunded: tr.querySelector('.warmupRefunded').checked,
      imageData: tr.querySelector('.imgInput').dataset.image || '',
      profit: tr.querySelector('.profit').value || ''
    };
  }

  function saveData(){
    const rows = Array.from(tableBody.querySelectorAll('tr')).map(getRowData);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
  }

  function restoreData(){
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      const rows = JSON.parse(raw);
      if (!Array.isArray(rows)) return;
      rows.forEach(r => addRow(r));
    } catch(e){
      console.warn('Не вдалося завантажити дані:', e);
    }
  }

  function handleImage(input, imgEl){
    const file = input.files && input.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      const dataUrl = e.target.result;
      input.dataset.image = dataUrl;
      imgEl.src = dataUrl;
      saveData();
    };
    reader.readAsDataURL(file);
  }

  function makeEl(tag, className, attrs={}){
    const el = document.createElement(tag);
    if (className) el.className = className;
    Object.entries(attrs).forEach(([k,v]) => {
      if (k === 'text') el.textContent = v;
      else if (k === 'html') el.innerHTML = v;
      else el.setAttribute(k, v);
    });
    return el;
  }

  function addRow(data={}){
    const tr = document.createElement('tr');

    const tdProfile = makeEl('td');
    const inputProfile = makeEl('input','profile', {type:'text', value: data.profile || ''});
    inputProfile.addEventListener('input', saveData);
    tdProfile.appendChild(inputProfile);

    const tdEmail = makeEl('td');
    const inputEmail = makeEl('input','email', {type:'text', value: data.email || ''});
    inputEmail.addEventListener('input', saveData);
    tdEmail.appendChild(inputEmail);

    const tdPass = makeEl('td');
    const inputPass = makeEl('input','pass', {type:'text', value: data.pass || ''});
    inputPass.addEventListener('input', saveData);
    tdPass.appendChild(inputPass);

    const tdPhone = makeEl('td');
    const inputPhone = makeEl('input','phone', {type:'text', value: data.phone || ''});
    inputPhone.addEventListener('input', saveData);
    tdPhone.appendChild(inputPhone);

    const tdProductName = makeEl('td');
    const inputProductName = makeEl('input','productName', {type:'text', value: data.productName || ''});
    inputProductName.addEventListener('input', saveData);
    tdProductName.appendChild(inputProductName);

    const tdPriceProduct = makeEl('td');
    const inputPriceProduct = makeEl('input','priceProduct', {type:'number', value: data.priceProduct || ''});
    inputPriceProduct.addEventListener('input', () => { calcProfitForRow(tr); saveData(); });
    tdPriceProduct.appendChild(inputPriceProduct);

    const tdPriceWarmup = makeEl('td');
    const inputPriceWarmup = makeEl('input','priceWarmup', {type:'number', value: data.priceWarmup || ''});
    inputPriceWarmup.addEventListener('input', () => { calcProfitForRow(tr); saveData(); });
    tdPriceWarmup.appendChild(inputPriceWarmup);

    const tdPriceSell = makeEl('td');
    const inputPriceSell = makeEl('input','priceSell', {type:'number', value: data.priceSell || ''});
    inputPriceSell.addEventListener('input', () => { calcProfitForRow(tr); saveData(); });
    tdPriceSell.appendChild(inputPriceSell);

    const tdProdRefund = makeEl('td');
    const inputProdRefund = makeEl('input','productRefunded', {type:'checkbox'});
    inputProdRefund.checked = !!data.productRefunded;
    inputProdRefund.addEventListener('change', () => { calcProfitForRow(tr); saveData(); });
    tdProdRefund.appendChild(inputProdRefund);

    const tdWarmRefund = makeEl('td');
    const inputWarmRefund = makeEl('input','warmupRefunded', {type:'checkbox'});
    inputWarmRefund.checked = !!data.warmupRefunded;
    inputWarmRefund.addEventListener('change', () => { calcProfitForRow(tr); saveData(); });
    tdWarmRefund.appendChild(inputWarmRefund);

    const tdImage = makeEl('td','image-col');
    const inputImg = makeEl('input','imgInput',{type:'file', accept:'image/*'});
    const imgPreview = makeEl('img','preview',{src: data.imageData || ''});
    const viewBtn = makeEl('button','icon-btn',{type:'button', text:'Переглянути'});
    if (data.imageData) inputImg.dataset.image = data.imageData;
    inputImg.addEventListener('change', () => handleImage(inputImg, imgPreview));
    viewBtn.addEventListener('click', () => {
      const src = inputImg.dataset.image || imgPreview.src;
      if (src) openModal(src);
    });
    tdImage.appendChild(inputImg);
    tdImage.appendChild(imgPreview);
    tdImage.appendChild(viewBtn);

    const tdProfit = makeEl('td');
    const inputProfit = makeEl('input','profit',{type:'number', value: data.profit || '', readonly:''});
    tdProfit.appendChild(inputProfit);

    const tdAction = makeEl('td');
    const delBtn = makeEl('button','icon-btn',{type:'button', text:'🗑'});
    delBtn.addEventListener('click', () => { tr.remove(); saveData(); });
    tdAction.appendChild(delBtn);

    tr.append(
      tdProfile, tdEmail, tdPass, tdPhone, tdProductName,
      tdPriceProduct, tdPriceWarmup, tdPriceSell,
      tdProdRefund, tdWarmRefund, tdImage, tdProfit, tdAction
    );

    tableBody.appendChild(tr);
    calcProfitForRow(tr);
    saveData();
  }

  addRowBtn.addEventListener('click', () => addRow());
  clearDataBtn.addEventListener('click', () => {
    if (confirm('Очистити всі локальні дані?')) {
      localStorage.removeItem(STORAGE_KEY);
      tableBody.innerHTML='';
    }
  });

  // Ініціалізація
  restoreData();
})();
</script>
</body>
</html>
